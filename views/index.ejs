<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Attendance Manager</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <h1>ðŸ‘¥ Member Attendance Manager</h1>

  <!-- Add Member -->
  <h2>Add Member</h2>
  <form action="/members" method="POST">
    <input type="text" name="name" placeholder="Member Name" required />
    <button type="submit">Add Member</button>
  </form>

  <!-- Members & Attendance -->
  <h2>Members & Attendance</h2>
  <% if (members.length === 0) { %>
    <p>No members yet.</p>
  <% } else { %>
    <% members.forEach(member => { %>
      <div class="member">
        <form action="/members/<%= member.id %>/attendance" method="POST">
          <strong><%= member.name %></strong>
          <% for (let i = 0; i < 8; i++) { %>
            <label>
              <input type="checkbox" name="attendance" <%= member.attendance[i] ? 'checked' : '' %> />
              Event <%= i + 1 %>
            </label>
          <% } %>
          <button type="submit">Update Attendance</button>
        </form>
        <form action="/members/<%= member.id %>/delete" method="POST" style="display:inline;">
          <button type="submit" onclick="return confirm('Remove this member?')">Remove</button>
        </form>
      </div>
    <% }); %>
  <% } %>

  <hr/>

  <!-- Eligibility Check Section -->
  <h2>Eligibility</h2>

  <!-- Dropdown to select a Category -->
  <form id="eligibilityForm">
    <label for="categorySelect">Select Item Category:</label>
    <select id="categorySelect" name="category" onchange="loadItems()">
      <option value="">-- Select Category --</option>
      <% categories.forEach(category => { %>
        <option value="<%= category.id %>"><%= category.name %></option>
      <% }); %>
    </select>
  </form>

  <!-- Dropdown to select an Item (populated based on Category) -->
  <form id="itemForm" style="display:none;">
    <label for="itemSelect">Select Item:</label>
    <select id="itemSelect" name="item">
      <option value="">-- Select Item --</option>
    </select>
  </form>

  <!-- Button to Check Eligibility -->
  <button id="checkEligibilityButton" onclick="checkEligibility()">Check Eligibility</button>

  <!-- Eligible Members List -->
  <h3>Eligible Members:</h3>
  <ul id="eligibleMembersList"></ul>

  <hr/>

  <script>
    // Load items when a category is selected
    function loadItems() {
      const categoryId = document.getElementById('categorySelect').value;
      const itemSelect = document.getElementById('itemSelect');
      const itemForm = document.getElementById('itemForm');
      const categories = <%= JSON.stringify(categories) %>;

      // Clear previous items
      itemSelect.innerHTML = '<option value="">-- Select Item --</option>';

      if (!categoryId) {
        itemForm.style.display = 'none';
        return;
      }

      const category = categories.find(cat => cat.id == categoryId);

      category.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        itemSelect.appendChild(option);
      });

      itemForm.style.display = 'block';
    }

    // Check eligibility based on the selected item
    function checkEligibility() {
      const categoryId = document.getElementById('categorySelect').value;
      const itemId = document.getElementById('itemSelect').value;
      const members = <%= JSON.stringify(members) %>;
      const categories = <%= JSON.stringify(categories) %>;
      const eligibleMembersList = document.getElementById('eligibleMembersList');

      // Clear previous eligibility list
      eligibleMembersList.innerHTML = '';

      if (!itemId || !categoryId) {
        return;
      }

      const category = categories.find(cat => cat.id == categoryId);
      const item = category.items.find(item => item.id == itemId);

      // Check each member
      members.forEach(member => {
        const hasItem = member.items.some(item => item.itemId == itemId);
        const attendedEvents = member.attendance.filter(attended => attended).length;

        // If the member has the item and attended at least 4 events
        if (hasItem && attendedEvents >= 4) {
          const listItem = document.createElement('li');
          listItem.textContent = member.name;
          eligibleMembersList.appendChild(listItem);
        }
      });
    }
  </script>
</body>
</html>
